name: ci

on:
  push:
    branches: [main, dev]
  pull_request:
    branches: [main, dev]

permissions:
  contents: read # 코드 읽기 권한
  pull-requests: write # 자동리뷰어 설정을 위한 쓰기 권한

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    steps:
      # 저장소 코드 다운로드
      - name: Checkout Code
        uses: actions/checkout@v5
      # pnpm 설치
      - name: Install pnpm
        uses: pnpm/action-setup@v4
        with:
          version: 10

      # pnpm store 캐싱
      - name: Get pnpm store directory
        id: pnpm-cache
        run: echo "STORE_PATH=$(pnpm store path)" >> $GITHUB_OUTPUT

      - uses: actions/cache@v5
        with:
          path: ${{ steps.pnpm-cache.outputs.STORE_PATH }}
          key: ${{ runner.os }}-pnpm-${{ hashFiles('pnpm-lock.yaml') }}
          restore-keys: ${{ runner.os }}-pnpm-

      # node.js 환경 설정
      - name: Setup Node.js
        uses: actions/setup-node@v5
        with:
          node-version: "24.x"
      # 라이브러리 설치
      - name: Install dependencies
        run: pnpm install --frozen-lockfile
      # 프로젝트 린트 검사 및 타입 검사
      - name: Check project
        id: check_step
        run: pnpm run lint && pnpm exec tsc --noEmit
        continue-on-error: true
      # 프로젝트 빌드
      - name: Build project
        id: build_step
        run: pnpm run build
        continue-on-error: true

      # 빌드 실패 시, 종료
      - name: Check Build Status
        if: steps.check_step.outcome == 'failure' || steps.build_step.outcome == 'failure'
        run: exit 1
